<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>PDF edit and create</title>

<style>
  TEXTAREA { width:400px; height: 4em; background-color: lightyellow; }
  TD { vertical-align: top; }
  
  .custom-menu {
    display: none;
    z-index: 1000;
    position: absolute;
    overflow: hidden;
    border: 1px solid gray;
    white-space: nowrap;
    font: normal 12px Arial,Sans;
    background: white;
    color: #444;
    border-radius: 5px;
    padding: 8px;
    box-shadow: 0px 2px 12px gray;
  }
  .custom-menu li {
    padding: 2px;
    cursor: pointer;
    list-style-type: none;
  }
  .custom-menu li:hover {
    color: white;
    background-color: #555599;
  }
  .Fdt { font:normal 10pt Helvetica,Arial; color: darkblue; }
  .Fdt:hover { background-color: lightblue; cursor: pointer; }
</style>
<script type="text/javascript">

var Mng = {
  
  xCollection: 'files', curElem: null, cntxMenu: null, xTitle: 'title', xThems: 'theme', xContent: 'content', tblOut: 'out',
  contextMenu: [
    { text: 'Open', exe: 'Mng.getOne(Mng.curElem.innerHTML)' },
    { text: 'Rename', exe: 'Mng.Rename(Mng.curElem.innerHTML,Mng.curElem.getAttribute("ref"))' },
    { text: 'Delete', exe: 'Mng.Delete(Mng.curElem.innerHTML)' },
    { text: 'Download', exe: 'Mng.Download(Mng.curElem.innerHTML)' },
    { text: 'Cancel', exe: null}],

  Send: function( jsonMsg ) {
    try {
      var msg = JSON.stringify( jsonMsg );
      var http = new XMLHttpRequest();
      http.open('POST', '/', false);
      http.send(msg);
      if(http.responseText.charAt(0) == '0') { alert(http.responseText.substr(1)); return false; }
      return http.responseText;
    } catch(e) { alert(e.message); return 'Error!'; }
  },
  
  buildTable: function( txt ) {
    var x = JSON.parse(txt), L = x.length, t = '<table>';
    for(var i=0; i<L; i++) t += '<TR><td class="Fdt" ref="'+ x[i]._id +'" oncontextmenu="Mng.rClick(event,this)" onclick="Mng.getOne(this.innerHTML)">'+x[i].file+'</td><td class="Fdt">' + this.getDF(x[i].modified) + '</td><td></TR>';
    id(this.tblOut).innerHTML = t + '</table>';
  },
  
  getDF: function(x){
    var s = (new Date(x)).toString().split(' ');
    return s[0] + ',&nbsp;' + s[2] + '&nbsp;' + s[1] + ',&nbsp;' + s[4];
  },
  
  Rename: function( fName, fId ) {
    var res; if(!(res = window.prompt("Rename:", fName)) || res == fName) return;
    this.Send( { collection: this.xCollection, id: fId, file: res.trim(), action: 'rename' } );
    this.listIt();
  },
  
  Delete: function( fName ) {
    if(!window.confirm("Delete " + fName + "?")) return;
    this.Send( { collection: this.xCollection, file: fName, action: 'remove' } );
    this.listIt();
  },
  
  getOne: function( fName ) {
    var r = this.Send( { collection: this.xCollection, file: fName, action: 'get one' } );
    var j = JSON.parse(r);
    id(this.xTitle).value = j.file;
    id(this.xThems).value = j.theme;
    id(this.xContent).value = j.content;
  },
  
  Download: function( fName ) {
    this.Send( { collection: this.xCollection, file: fName, action: 'download' } );
  },
  
  listIt: function() {
    this.buildTable( this.Send( { collection: this.xCollection, action: 'list' } ));
  },
  
  Save: function() {
    this.Send( { collection: this.xCollection, file: id('title').value.trim(), theme: id('theme').value.trim(), content: id('content').value.trim(), action: 'save' } );
    this.listIt();
  },
  
  rClick: function( e, obj ) {
    e.preventDefault();
    if(this.curElem) this.curElem.style.backgroundColor = '';
    (this.curElem = obj).style.backgroundColor = 'yellow';
    if(this.cntxMenu == null) this.createCntx();
    var m = this.cntxMenu.style, pos = this.getPosition(e);
      m.top = pos.y + 'px';
      m.left = pos.x + 'px';
      m.display = 'block';
        document.addEventListener('click', function(e) {
          Mng.mnuCntx.style.display = 'none';
          document.removeEventListener("click");
          Mng.curElem.style.backgroundColor = ''; Mng.curElem = null;
        });
    return false;
  },

  getPosition: function(e) {
    if(!e) e = window.event;
    if(e.pageX || e.pageY) return({ x: e.pageX, y: e.pageY });
    else if(e.clientX || e.clientY) return({ x: e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft, y: e.clientY + document.body.scrollTop + document.documentElement.scrollTop });
    return { x:0, y:0 };
  },
  
  createCntx: function() {
    var u = document.createElement('ul');
    u.className = 'custom-menu';
    u.id = 'mnu';
    for (var i=0, C=this.contextMenu, L=C.length; i<L; i++) {
      var li = document.createElement('li');
      u.appendChild(li);
      li.innerHTML = C[i].text;
      li.addEventListener('click',C[i].exe);
    }
    document.body.appendChild(u);
    this.cntxMenu = u;
  }
}

function id(x) { return document.getElementById(x); }


</script>
</head>
<body onload='Mng.listIt()'>

<table>
  <tr>
    <td>Action:</td>
    <td>
      <input type='button' value='Save' onClick='Mng.Save()'>
    </td>
  </tr>
  <tr>
    <td>File:</td>
    <td>
      <TEXTAREA id='title'>
      A new PDF file/title.
      </TEXTAREA>
    </td>
  </tr>
  <tr>
    <td>Theme:</td>
    <td>
      <TEXTAREA id='theme'>
      body { font:normal 12pt Verdana; color:darkblue; }
      i { color:blue; }
      </TEXTAREA>
    </td>
  </tr>
  <tr>
    <td>Content:</td>
    <td>
      <TEXTAREA id='content'>
      Al doilea. Un <i>oarecare</i> text.<br>
      Aici continua cu titlul.<br>
      <h1>Vine titlul</h1>
      Acum continuam fara titlu.
      </TEXTAREA>
    </td>
  </tr>
</table>

<div id='out'></div>

<!-- <ul id='mnu' class='custom-menu'>
  <li onclick='Mng.getOne(Mng.curElem.innerHTML)'>Open</li>
  <li onclick='Mng.Rename(Mng.curElem.innerHTML,Mng.curElem.getAttribute("ref"))'>Rename</li>
  <li onclick='Mng.Delete(Mng.curElem.innerHTML)'>Delete</li>
  <li onclick='Mng.Download(Mng.curElem.innerHTML)'>Download</li>
  <li>Cancel</li>
</ul> -->

</body>
</html>
